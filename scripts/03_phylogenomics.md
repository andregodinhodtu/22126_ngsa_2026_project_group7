# Pipeline carried to perform phylogenomics analysis 

Analysis of the ITS Region Following the Original Study

The original study published its polished ITS region dataset on GenBank, which combined publicly available reference sequences with the authors’ processed data derived from their raw sequence analyses. The GenBank sequences referenced in the study were retrieved by the authors using specific keyword searches, after which representative sequences for each strain were selected. These sequences were used to construct Figure 1 in the original paper and served as the basis for the dataset utilized in this analysis.

In the first stage of this work, the same dataset was retrieved and analyzed in order to replicate the results reported in the original publication and to verify the consistency of the methodology.

In the second stage, a new dataset was constructed by combining the same GenBank reference sequences with results from independent analyses of the raw sequences. This dataset represented the newly generated data within the present study and was used to perform comparative analyses with the original findings.

## 0. Identification and orientation of in-house ITS sequences (second stage only)

ITS sequences generated by our group were pooled, dereplicated, and locally aligned against the reference ITS dataset from the original study, using pwalign (version 1.6.0). For each unique sequence, alignments were performed in both forward and reverse-complement orientations, and the best match was selected based on alignment score. Sequences were reoriented when necessary and renamed to indicate their closest GenBank reference. The resulting curated sequences were exported and combined with the reference dataset for downstream analyses.

```{r}
input_folder <- "path/to/seq_folder/" 

ref_db <- readDNAStringSet("path/togenebank_references.fasta")

file_list <- list.files(input_folder, pattern = "\\.fasta$", full.names = TRUE)
all_reads <- DNAStringSet()
for (f in file_list) {
  try({
    s <- readDNAStringSet(f)

    if (length(s) > 0) {
      all_reads <- c(all_reads, s)
    }

  }, silent = TRUE)}
unique_reads <- unique(all_reads)

results_table <- data.frame(
  Sequence_ID = character(),
  Best_GenBank_Match = character(),
  Score = numeric(),
  Orientation = character(),
  stringsAsFactors = FALSE
)

final_fasta <- DNAStringSet()

for (i in 1:length(unique_reads)) {
  current_seq <- unique_reads[[i]]
  scores_fwd <- pairwiseAlignment(ref_db, current_seq, type="local", scoreOnly=TRUE)
  max_fwd <- max(scores_fwd)

  current_rev <- reverseComplement(current_seq)
  scores_rev <- pairwiseAlignment(ref_db, current_rev, type="local", scoreOnly=TRUE)
  max_rev <- max(scores_rev)

  best_score <- max(max_fwd, max_rev)

  if (best_score > 200) {
    if (max_rev > max_fwd) {
      final_seq_raw <- current_rev
      orientation <- "Reverse"
      best_ref_index <- which.max(scores_rev)
    } else {
      final_seq_raw <- current_seq
      orientation <- "Forward"
      best_ref_index <- which.max(scores_fwd)
    }
    

    best_ref_name <- names(ref_db)[best_ref_index]
    best_ref_name_clean <- sub(" .*", "", best_ref_name) 
    
    new_id <- paste0("Seq_Unique_", i)
    full_name <- paste0(new_id, "_matches_", best_ref_name_clean)
    
    results_table[nrow(results_table) + 1, ] <- c(
      new_id,
      best_ref_name_clean,
      best_score,
      orientation
    )
    
    temp_set <- DNAStringSet(final_seq_raw)
    names(temp_set) <- full_name
    final_fasta <- c(final_fasta, temp_set)
  }
}
```

## 1. Local alignment and trimming of fasta files 

Local alignment of FASTA sequences were performed using the CLUSTAL W algorithm implemented in the msa R package (version 1.42.0). The resulting alignments were visually inspected in MEGA (version 12), and sequences were trimmed between positions 162 and 384, yielding the same alignment length as reported in the original study (224 bp).

```{r}
fasta_file <-  "path/to/fasta_file.fasta"
its_biostrings <- readDNAStringSet(fasta_file)
alignment <- msa(its_biostrings, method = "ClustalW")

alignment_ape <- as.DNAbin(alignment)
image(alignment_ape)

# Trimming indexes were chosen using MEGA software for accurate visualization 
its_trimmed <- alignment_ape[, 162:384]
image(its_trimmed) 
```

## 2. Best-fitting nucleotide substituiton model

In the original study, the optimal nucleotide substitution model for the ITS region was determined using jModelTest, which identified the Hasegawa–Kishino–Yano model with a gamma distribution and equal rate weights (HKY+G). Model selection performed with the phangorn R package (version 2.12.1) supported the same model.

```{r}

phylo_data <- phyDat(its_trimmed, type = "DNA")

mt <- modelTest(phylo_data)
head(mt[order(mt$BIC),])

# Model         df  logLik    AIC      AICw        AICc       AICcw     BIC
# 15   HKY+G(4) 48 -802.7573 1701.515 0.0192777954 1728.549 0.082182212 1865.059
# 43 TPM2u+G(4) 49 -800.6062 1699.212 0.0609512337 1727.536 0.136380764 1866.164
# 39  TPM2+G(4) 46 -809.2713 1710.543 0.0002111871 1735.111 0.003089856 1867.272
# 35 TPM1u+G(4) 49 -801.3030 1700.606 0.0303634294 1728.930 0.067939358 1867.557
# 23   TrN+G(4) 49 -801.3930 1700.786 0.0277508310 1729.110 0.062093567 1867.737
# 16 HKY+G(4)+I 49 -801.7760 1701.552 0.0189203852 1729.876 0.042335100 1868.503

```

## 3. Running BEAUTi

Analyses were conducted in BEAUTi (version 10.5.0) using a strict molecular clock and the Hasegawa–Kishino–Yano substitution model with a gamma distribution and equal rate weights (HKY+G). A Yule process was specified as the tree prior. The Markov chain was run for 25,000,000 generations, with parameters sampled every 1,000 generations.

## 4. Running BEAST

BEAST (version 10.5.0) was used for Bayesian phylogenetic analysis. The BEAGLE library (version 4.0.0) was installed to optimize computational performance during likelihood calculations.

## 5. Tracer to confirm convergence

Convergence diagnostics were intended to be performed using Tracer. However, compatibility issues arose due to the requirement for an older Java version. To address this, a custom script was developed to evaluate parameter convergence.

```{r}

logfile <- read.table("path/to/log_file.log")

burnin_fraction <- 0.1
n_samples <- nrow(logfile)
start_index <- round(n_samples * burnin_fraction)
chain_data <- logfile[start_index:n_samples, ]

mcmc_chain <- as.mcmc(chain_data)

ess_values <- effectiveSize(mcmc_chain)
print("ESS Values (aim for > 200):")
print(ess_values)

```

## 6. TreeAnnotator to build the tree

TreeAnnotator (version 10.5.0) was used to summarize the sampled trees and generate the maximum clade credibility (MCC) tree. A 10% burn-in (2500 trees) was applied to exclude the initial portion of the MCMC samples prior to summarization, ensuring only post-convergence trees were included in the final analysis.

## 7. Visualization of the tree 

```{r}

tree <- read.beast("path/to/beast_output.tree")

tree@phylo$tip.label <- sub(" .*", "", tree@phylo$tip.label)

dd <- data.frame(label = tree@phylo$tip.label)

dd <- dd %>% 
  mutate(
    group = case_when(
      grepl("Seq_Unique", label) ~ "My Strain",
      grepl("AY244648", label) ~ "Outgroup",
      TRUE ~ "Reference"
    ),
    
    font_face = case_when(
      group == "My Strain" ~ "bold",
      group == "Outgroup" ~ "bold",
      TRUE ~ "bold"
    ),
    
    color = case_when(
      group == "My Strain" ~ "#E41A1C",   
      group == "Outgroup"  ~ "#009E73",    
      TRUE ~ "black"
    )
  )


ggtree(tree) %<+% dd +
  coord_cartesian(xlim = c(0, 0.35), clip = "off") +
  geom_tiplab(
    aes(fontface = font_face, color = color), 
    size = 4.5,           
    align = TRUE,         
    linesize = 0.3
  ) +        
  geom_nodelab(
    aes(label = ifelse(posterior > 0.5, round(posterior, 2), "")), 
    vjust = -1, 
    hjust = 1.3, 
    size = 3.5,
    fontface = "italic"
  ) +
  geom_nodepoint(size=0.5, color="black", alpha=1) +
  theme_tree2() +
  scale_color_manual(values = c("#009E73", "#E41A1C", "black")) +
  xlim(0, 0.25) + 
  labs(title = "Phylogenetic analysis of Trichomonas gallinae (ITS region)", 
       subtitle = "Maximum clade credibility tree using Bayesian Inference (BEAST)") +
  theme(plot.title = element_text(size = 20, face = "bold", hjust = 0),
        plot.subtitle = element_text(size = 17, lineheight = 1.2),
        legend.position = "none")
```

The resulting maximum clade credibility (MCC) tree was visualized in R using the output file generated by TreeAnnotator. Visualization and annotation were carried out with the treeio, ggtree, ape, and tidyverse packages, enabling detailed inspection of tree topology and clade support.


